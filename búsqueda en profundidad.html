<!doctype html />
<html lang="es">
	<head>
	<meta charset="UTF-8" />
	<meta name="author" content="Carlos Grasa" />
	<title>Búsqueda</title>
	<script type="text/javascript">
var campoEstadoInicial; // interfaz para estado
var campoLimiteInicial; // interfaz para limite
var campoFormulaLimite; // interfaz para formulaLimite
var campoUltimoEsGanador; // interfaz para ultimoEsGanador
var botonBuscar; // interfaz para botón buscar
var campoResultado; // interfaz para resultado

var estado; // estado inicial de juego
var limite; // límite inicial de jugada
var formulaLimite; // fórmula para calcular límite de jugada
var ultimoEsGanador; // gana o no el último jugador
var calcularLimite; // función para calcular límite actual según la jugada anterior n
var nivel; // 
var profundidad;
var numNodos;
var tiempo;

addEventListener("load",iniciarInterfaz,false);

function iniciarInterfaz() {
	campoEstadoInicial=document.getElementById("estadoinicial");
	campoLimiteInicial=document.getElementById("limiteinicial");
	campoFormulaLimite=document.getElementById("formulalimite");
	campoUltimoEsGanador=document.getElementById("ultimoesganador");
	botonBuscar=document.getElementById("botonbuscar");
	campoResultado=document.getElementById("resultado");

	botonBuscar.addEventListener("click",entrarDatos,false);
	return;
}

function entrarDatos() {
	campoResultado.innerHTML="";
	estado=campoEstadoInicial.value*1;
	if (!isFinite(estado) || estado<1 || Math.floor(estado)<estado) {
		informar("Error en estado inicial.");
		return;
	}
	limite=campoLimiteInicial.value*1;
	if (!isFinite(limite) || limite<1 || Math.floor(limite)<limite || limite>estado) {
		informar("Error en límite inicial.");
		return;
	}
	formulaLimite=campoFormulaLimite.value;
	calcularLimite=new Function("estado","n","var limite="+formulaLimite+"; return limite>estado ? estado : limite;");
	var prueba=calcularLimite(1000000000,1);
	if (!isFinite(prueba) || prueba<1 || Math.floor(prueba)<prueba) {
		informar("Error en cálculo de límite.");
		return;
	}
	ultimoEsGanador=campoUltimoEsGanador.value=="ultimoesganador";
	informar("Estado: "+estado+", límite: "+limite+(ultimoEsGanador ? ", ganando" : ", perdiendo")+" quien juega el último, fórmula: f(n)="+formulaLimite+"<br />Buscando jugadas ganadoras...");
	buscarSoluciones();
	return;
}

function informar(dato) {
	campoResultado.innerHTML+=dato;
	return;
}

function resumir(x) {
	var n=Math.floor(Math.log(x)/Math.LN10/3);
	var y=new Number(x/Math.pow(10,3*n)).toFixed(1);
	switch (n) {
		case 0: return y; break;
		case 1: return y+" K"; break;
		case 2: return y+" M"; break;
		case 3: return y+" G"; break;
		case 4: return y+" T"; break;
		case 5: return y+" P"; break;
		default: return x;
	}
}

function lapso() {
	var ahora=new Date();
	var ms=ahora-tiempo;
	tiempo=ahora;
	return ms;
}

function evaluarNodo(estado,limite) {
	numNodos++;
	if (ultimoEsGanador) {
		if (estado==0)
			return false;
		else if (limite>=estado)
			return true;
	} else {
		if (estado==0)
			return true;
		else if (estado==1)
			return false;
		else if (limite+1>=estado)
			return true;
	}
	for (var j=1;j<=limite;j++) {
		nivel++;
		if (nivel>profundidad)
		  profundidad=nivel;
		if (!evaluarNodo(estado-j,calcularLimite(estado-j,j))) {
			nivel--;
			return true;
		} else
	    nivel--;
  }
	return false;
}

function buscarSoluciones() {
	lapso();
	nivel=0;
	profundidad=0;
	numNodos=0;
	for (var n=1;n<=limite;n++)
		if (!evaluarNodo(estado-n,calcularLimite(estado-n,n)))
			informar("<br />Jugar "+n);
	informar("<br />Nodos evaluados: "+numNodos+" ("+resumir(numNodos)+"), profundidad: "+profundidad+", tiempo: "+lapso()+" ms");
	return;
}
	</script>
	</head>
	<body style="background-color: #FFF0E0;">
		<hr />
		<label>Estado inicial:</label>
		<input id="estadoinicial" type="text" size="15" value="" />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<label>Jugada máxima inicial:</label>
		<input id="limiteinicial" type="text" size="15" value="" />
		<br /><br />
		<label>Cálculo de jugada máxima según precedente (n):</label>
		<input id="formulalimite" type="text" size="80" value="" />
		<br /><br />
		<label>Último en jugar es ganador:</label>
		<select id="ultimoesganador">
			<option value="ultimoesganador">Gana quien juega el último</option>
			<option value="ultimoesperdedor">Pierde quien juega el último</option>
		</select>
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<input id="botonbuscar" type="button" value="Buscar jugadas" />
		<hr />
		<label>Resultado:</label>
		<br /><br />
		<span id="resultado">
		</span>
		<hr />
		<h6 style="text-align: right; color: #D0D0D0;">
			&copy; Carlos Grasa Lambea
		</h6>
	</body>
</html>